image: node:22

stages:
  - ci
  - cd

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

variables:
  NODE_ENV: test

ci:
  stage: ci
  script:
    # Install
    - npm ci || npm install

    # Lint
    - npm run lint

    # Test
    - npm run test:backend
    - npm run test:frontend
    - npm run test:frontend:coverage
    - npm run test:backend:coverage

    # Build
    - npm run build:frontend
    - node --check backend/src/server.js

  artifacts:
    when: always
    paths:
      - frontend/dist/
      - backend/
      - coverage/
      - frontend/coverage/
    expire_in: 1 week

cd:
  stage: cd
  needs: [ci]
  when: manual   # EI ajaudu automaattisesti, vain manuaalisena
  script:
    - echo "CD job is currently disabled in GitLab (to avoid credit usage)"
    # - curl -X POST "$RENDER_DEPLOY_HOOK"
    # - curl -X POST "$NETLIFY_BUILD_HOOK_URL"