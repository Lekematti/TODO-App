image: node:22

stages:
  - ci
  - cd

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

variables:
  NODE_ENV: test

ci:
  stage: ci
  script:
    # Install
    - npm ci || npm install

    # Lint
    - npm run lint

    # Test
    - npm run test:backend
    - npm run test:frontend
    - npm run test:frontend:coverage
    - npm run test:backend:coverage

    # Build
    - npm run build:frontend
    - node --check backend/src/server.js

  artifacts:
    when: always
    paths:
      - frontend/dist/
      - backend/
      - coverage/
      - frontend/coverage/
    expire_in: 1 week

cd:
  stage: cd
  needs: [ci]
  when: manual   # ei aja automaattisesti, vain kun klikkaat GitLabista

  script:
    - echo "Starting manual deploy from GitLab CI..."

    # Frontend: Netlify
    - |
      if [ -n "$NETLIFY_AUTH_TOKEN" ] && [ -n "$NETLIFY_SITE_ID" ]; then
        echo "Triggering Netlify deploy..."
        curl -X POST \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN" \
          https://api.netlify.com/api/v1/sites/$NETLIFY_SITE_ID/builds
      else
        echo "Netlify variables missing, skipping frontend deploy."
      fi

    # Backend: Render
    - |
      if [ -n "$RENDER_DEPLOY_HOOK" ]; then
        echo "Triggering Render deploy..."
        curl -X POST "$RENDER_DEPLOY_HOOK"
      else
        echo "RENDER_DEPLOY_HOOK missing, skipping backend deploy."
      fi