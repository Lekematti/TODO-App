trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

variables:
  NODE_VERSION: "20.x"

stages:
  - stage: CI
    jobs:
      - job: ci
        pool:
          name: local-agent
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: "$(NODE_VERSION)"
            displayName: "Use Node.js $(NODE_VERSION)"

          - powershell: npm ci
            displayName: "Install dependencies"

          - powershell: npm run lint
            displayName: "Lint"

          - powershell: |
              $env:NODE_ENV = "test"
              $env:DB_FILE = "backend/test-todos.sqlite"
              node --test backend/tests
            displayName: "Backend tests"

          - powershell: npm run test:frontend
            displayName: "Frontend tests"

          - powershell: npm run test:frontend:coverage
            displayName: "Frontend coverage"

          - powershell: |
              $env:NODE_ENV = "test"
              $env:DB_FILE = "backend/test-todos.sqlite"
              npx c8 node --test backend/tests
            displayName: "Backend coverage"

          - powershell: npm run build:frontend
            displayName: "Build frontend"
            env:
              VITE_API_BASE_URL: $(VITE_API_BASE_URL)

          - powershell: node --check backend/src/server.js
            displayName: "Validate backend (syntax)"

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "frontend/dist"
              ArtifactName: "frontend-dist"

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "backend"
              ArtifactName: "backend-code"

  - stage: CD
    dependsOn: CI
    condition: succeeded()
    jobs:
      - job: deploy_static
        pool:
          name: local-agent
        steps:
          - download: current
            artifact: frontend-dist

          - powershell: |
              az storage blob upload-batch `
                --account-name "$env:AZURE_STORAGE_ACCOUNT" `
                --account-key "$env:AZURE_STORAGE_KEY" `
                --destination '$web' `
                --source "$(Pipeline.Workspace)\frontend-dist" `
                --overwrite true
            displayName: "Upload frontend to $web"
            env:
              AZURE_STORAGE_ACCOUNT: $(AZURE_STORAGE_ACCOUNT)
              AZURE_STORAGE_KEY: $(AZURE_STORAGE_KEY)
