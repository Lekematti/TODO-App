trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

variables:
  NODE_VERSION: "20.x"
  VITE_API_BASE_URL: ""
  AZURE_STORAGE_ACCOUNT: ""
  AZURE_STORAGE_RG: ""
  AZURE_SERVICE_CONNECTION: ""

stages:
  - stage: CI
    jobs:
      - job: ci
        pool:
          name: local-agent
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: "$(NODE_VERSION)"
            displayName: "Use Node.js $(NODE_VERSION)"

          - script: npm ci
            displayName: "Install dependencies"

          - script: npm run lint
            displayName: "Lint"

          - script: npm run test:backend
            displayName: "Backend tests"

          - script: npm run test:frontend
            displayName: "Frontend tests"

          - script: npm run test:frontend:coverage
            displayName: "Frontend coverage"

          - script: npm run test:backend:coverage
            displayName: "Backend coverage"

          - script: npm run build:frontend
            displayName: "Build frontend"
            env:
              VITE_API_BASE_URL: $(VITE_API_BASE_URL)

          - script: node --check backend/src/server.js
            displayName: "Validate backend (syntax)"

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "frontend/dist"
              ArtifactName: "frontend-dist"

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "backend"
              ArtifactName: "backend-code"

  - stage: CD
    dependsOn: CI
    condition: succeeded()
    jobs:
      - job: deploy_static
        pool:
          name: local-agent
        steps:
          - download: current
            artifact: frontend-dist

          - script: |
              az storage blob upload-batch \
                --account-name "$(AZURE_STORAGE_ACCOUNT)" \
                --account-key "$(AZURE_STORAGE_KEY)" \
                --destination '$web' \
                --source "$(Pipeline.Workspace)/frontend-dist" \
                --overwrite true
            displayName: "Upload frontend to $web"
